<!DOCTYPE html>
<html>
	<head>
		<title>Scrollable Demo - Basic</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link rel="stylesheet" href="http://cdn.kik.com/app/1/default.css">
		<style>
img {
	vertical-align: middle;
}
.item div {
	display: inline-block;
}
.app-list li,
.app-list li.app-button {
	height: 64px;
	padding: 4px 20px;
}
		</style>
	</head>

	<body>
		<div class="app-page" data-page="list">
			<div class="app-topbar">
				<div class="app-title">Scrollable Demo</div>
			</div>
			<div class="app-content" data-no-scroll="true">
				<ul class="app-list">
					<li class="item app-button template">
						<img src="http://placehold.it/64x64" />
						<div class="name">Loading...</div>
					</li>
				</ul>
			</div>
		</div>

		<div class="app-page" data-page="viewer">
			<div class="app-topbar">
				<div class="app-button left" data-back="true">Back</div>
				<div class="app-title"></div>
			</div>
			<div class="app-content">
				<img />
			</div>
		</div>


		<script src="http://cdn.kik.com/cards/0/cards.js"></script>
		<script src="http://cdn.kik.com/app/1/app.js"></script>

		<script src="/zerver/require.js"></script>
		<script src="../src/iscroll.js"      ></script>
		<script src="../src/scrollable.js"   ></script>
		<script src="../src/utils.js"        ></script>
		<script src="../src/scrollWatcher.js"></script>
		<script src="../src/core.js"         ></script>

		<script>
App.populator('list', function (page, data) {
	var list     = page.querySelector('.app-list');
	var content  = page.querySelector('.app-content');
	var template = list.querySelector('.template');

	template.parentNode.removeChild(template);

	var infini = new InfiniteScroller(content, template, generate);
	var iscroll = new iScroll(content, {
		onMove: function (x, y) {
			infini.setPos(-y);
		},
	});

	function generate(template, i) {
		var img = template.querySelector('img');
		img.src = getImageURL(i, 64, 64);

		var text = template.querySelector('div');
		text.innerText = "Item " + i;

		template.onclick = function () {
			var w = content.offsetWidth;
			var h = content.offsetHeight;
			App.load('viewer', {
				imgsrc: getImageURL(i, w, h),
				text: "Item " + i,
			});
		};
	}
});

App.populator('viewer', function (page, data) {
	var title = page.querySelector('.app-title');
	var img = page.querySelector('img');

	title.innerText = data.text;

	var loaderImg = [
		"data:image/gif;base64,",
		"R0lGODlhEAAQAPIAAAAAAP///zw8PLy8vP///5ycnHx8fGxsbCH+GkNyZWF0ZWQgd2l0aCBhamF4",
		"bG9hZC5pbmZvACH5BAAKAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAADMwi63P4wyklr",
		"E2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQACgABACwAAAAA",
		"EAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUk",
		"KhIAIfkEAAoAAgAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9",
		"HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkEAAoAAwAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYum",
		"CYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkEAAoABAAsAAAAABAAEAAAAzII",
		"unInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQACgAF",
		"ACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJ",
		"ibufbSlKAAAh+QQACgAGACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFG",
		"xTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAAKAAcALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdce",
		"CAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==",
	].join('');

	var s = img.style;
	s.width = '100%';
	s.height = '100%';
	s.background = 'url(' + loaderImg + ') no-repeat center center';
	img.src = data.imgsrc;
});

try {
	App.restore();
} catch (err) {
	App.load('list');
}

function mod(a, b) {
	return ((a % b) + b) % b;
}

function InfiniteScroller(wrapper, template, filler) {
	var self = this;
	var masters = [];
	var numMasters = 7;
	var itemHeight = 72;
	var slider = wrapper.children[0];
	var prevPos = 0;
	var curItem = 0;

	init();
	setPos(0);
	function init() {
		wrapper.style.position = 'relative';

		var s = slider.style;
		s.position = 'relative';
		s.top = '0';
		s.width = '100%';
		s.height = '100000px';

		for (var i = 0; i < numMasters; i++) {
			var elm = template.cloneNode(true);
			elm.style.position = 'absolute';
			elm.style.width = '100%';

			master = {elm: elm, item: -1};
			positionMaster(master, i);
			filler(master.elm, i);

			masters.push(master);
			slider.appendChild(elm);
		}
	}

	function positionMaster(master, item) {
		if (master.item === item) return;

		var s = master.elm.style;
		s.webkitTransform = 'translate3d(0px,' + item*itemHeight + 'px,0px)';
		master.item = item;
	}

	function setItem(newItem) {
		for (var i = 0; i < numMasters; i++) {
			var master = masters[i];
			var item = i + newItem;
			positionMaster(master, item);
		}
		curItem = newItem;
	}

	function nextItem() {
		var movingMaster = mod(curItem, numMasters);
		var master = masters[movingMaster];
		var item = curItem + numMasters;
		positionMaster(master, item);
		curItem++;
	}

	function prevItem() {
		var movingMaster = mod(curItem + numMasters - 1, numMasters);
		var master = masters[movingMaster];
		var item = curItem - 1;
		positionMaster(master, item);
		curItem--;
	}

	function setPos(curPos) {
		var newItem = Math.floor(curPos / itemHeight);

		if (newItem === curItem) return;

		if (Math.abs(newItem - curItem) >= numMasters) {
			setItem(newItem);
			return;
		}

		while (newItem > curItem) nextItem();
		while (newItem < curItem) prevItem();
	}
	self.setPos = setPos;
}

function getImageURL(num, width, height) {
	var categories = ['abstract', 'city', 'people', 'transport', 'animals', 'food', 'nature', 'business', 'nightlife', 'sports', 'cats', 'fashion', 'technics'];
	var categoryLength = 10;

	var category = categories[Math.floor(num / categoryLength) % categories.length];
	var categoryOffset = (num % categoryLength) + 1; // 1...10
	var url = 'http://lorempixel.com/' + width + '/' + height + '/' + category + '/' + categoryOffset;

	// Thumbnailer does caching for us.
	return getThumbnailURL(url, width, height, 1.0);
}
/*
	url     = URL of image (must contain a hostname)
	height  = desired height of thumbnail in pixels
	width   = desired width of thumbnail in pixels
	quality = desired quality of thumbnail (values are 0 to 2)

	If only one dimension is specified, aspect ratio will be preserved
	and the thumbnail will be a scaled version of the original.
	If both dimensions are specified, the image will be scaled and
	cropped to the desired dimensions.
*/
function getThumbnailURL (url, height, width, quality) {
	if (!height && !width) {
		throw 'height and/or width must be specified';
	}

	var BASE_URL = 'http://cards-thumbnailer.appspot.com/';
	var thumbURL = BASE_URL;

	thumbURL += encodeURIComponent(url) + '?';

	thumbURL += 'h=' + (height  || '') + '&';
	thumbURL += 'w=' + (width   || '') + '&';
	thumbURL += 'q=' + (quality || 0 );

	return thumbURL;
}
		</script>
	</body>
</html>
