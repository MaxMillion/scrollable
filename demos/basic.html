<!DOCTYPE html>
<html>
	<head>
		<title>Scrollable Demo - Basic</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link rel="stylesheet" href="http://cdn.kik.com/app/1/default.css">
		<style>
img {
	vertical-align: middle;
}
.entry {
	display: none;
}
.app-list .entry {
	height: 64px !important;
	display: block;
	border-bottom: 1px solid #CCC;
}
.entry .preview {
	position: relative;
	float: left;
}
.entry img {
	display: block;
	width: 64px;
	height: 64px;
}
.entry span {
	position: absolute;
	bottom: 4px;
	right: 4px;
	font-size: 12px;
}
/*.app-list > * {
	-webkit-transform: translate3d(0px, 0px, 0px);
}*/
.app-content {
	background: #FFF;
}
		</style>
	</head>

	<body>
		<div class="app-page" data-page="list">
			<div class="app-topbar">
				<div class="app-button left" data-back="true">Back</div>
				<div class="app-title">Scrollable Demo</div>
			</div>
			<div class="app-content">
				<ul class="app-list">
				</ul>
			</div>
		</div>

		<div class="app-page" data-page="viewer">
			<div class="app-topbar">
				<div class="app-button left" data-back="true">Back</div>
				<div class="app-title"></div>
			</div>
			<div class="app-content">
				<img />
			</div>
		</div>

		<div class="entry app-button">
			<div class="preview">
				<img>
				<span></span>
			</div>

			<div class="info">
			</div>
		</div>

		<script src="http://cdn.kik.com/cards/0/cards.js"></script>
		<script src="http://cdn.kik.com/app/1/app.js"></script>

		<script src="/zerver/require.js"></script>
		<script src="../src/iscroll.js"      ></script>
		<script src="../src/scrollable.js"   ></script>
		<script src="../src/utils.js"        ></script>
		<script src="../src/scrollWatcher.js"></script>
		<script src="../src/core.js"         ></script>

		<script>
App.populator('list', function (page, data) {
	var list    = page.querySelector('.app-list');
	var content = page.querySelector('.app-content');

	fillWithExampleItems(list);
// 			content.scrollable();

	function fillWithExampleItems(list, num) {
		var template = document.querySelector('.entry.app-button');
		num = num || 100;
		for (var i = 0; i < num; i++) {
			var elm = template.cloneNode(true);
			filler(elm, i);
			list.appendChild(elm);
		}
	}

	LongListScroller(page, list, 65);

	function filler(elm, i) {
		var img = elm.querySelector('img');
		img.src = getImageURL(i, 64, 64);

		var time = elm.querySelector('span');
		time.innerText = '10:' + i + Math.floor(Math.random() - 0.001);

		var info = elm.querySelector('.info');
		info.innerText = 'Item ' + i;

		Clickable(elm);
		elm.addEventListener('click', function () {
			var w = content.offsetWidth;
			var h = content.offsetHeight;
			App.load(i === 1 ? 'list' : 'viewer', {
				imgsrc: getImageURL(i, w, h),
				text: "Item " + i,
			});
		}, false);
	}
});

App.populator('viewer', function (page, data) {
	var title = page.querySelector('.app-title');
	var img = page.querySelector('img');

	title.innerText = data.text;

	var loaderImg = [
		"data:image/gif;base64,",
		"R0lGODlhEAAQAPIAAAAAAP///zw8PLy8vP///5ycnHx8fGxsbCH+GkNyZWF0ZWQgd2l0aCBhamF4",
		"bG9hZC5pbmZvACH5BAAKAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAADMwi63P4wyklr",
		"E2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQACgABACwAAAAA",
		"EAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUk",
		"KhIAIfkEAAoAAgAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9",
		"HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkEAAoAAwAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYum",
		"CYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkEAAoABAAsAAAAABAAEAAAAzII",
		"unInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQACgAF",
		"ACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJ",
		"ibufbSlKAAAh+QQACgAGACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFG",
		"xTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAAKAAcALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdce",
		"CAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==",
	].join('');

	var s = img.style;
	s.width = '100%';
	s.height = '100%';
	s.background = 'url(' + loaderImg + ') no-repeat center center';
	img.src = data.imgsrc;
});

try {
	App.restore();
} catch (err) {
	App.load('list');
}

// LongListScroller employes a variety of bugfixes and optimizations
// for reasonable long lists of fixed-height items. It assumes your
// app-content is scrollable, and will fix flickering and rendering
// glitches on iOS, with a minimal hit to performance (simply 3ding
// the entire contents works well for small lists, but causes
// significant creation/destruction lag for longer lists).
function LongListScroller(page, scroller, itemHeight) {
	var content = page.querySelector('.app-content');
	var elms = scroller.children;

	page.addEventListener('appShow', onAppShow, false);

	function onAppShow() {
		var pos = content._scrollTop();
		var height = window.innerHeight;

		var first = Math.floor(pos / itemHeight);
		var len = Math.ceil(height / itemHeight);

		for (var i = 0; i < elms.length; i++) {
// 			elms[i].style.webkitTransform = '';
		}

		for (var i = 0; i < len; i++) {
// 			elms[i + first].style.webkitTransform = 'translate3d(0px, 0px, 0px)';
		}
	}
}

function getImageURL(num, width, height) {
	var categories = ['abstract', 'city', 'people', 'transport', 'animals', 'food', 'nature', 'business', 'nightlife', 'sports', 'cats', 'fashion', 'technics'];
	var categoryLength = 10;

	var category = categories[Math.floor(num / categoryLength) % categories.length];
	var categoryOffset = (num % categoryLength) + 1; // 1...10
	var url = 'http://lorempixel.com/' + width + '/' + height + '/' + category + '/' + categoryOffset;

	// Thumbnailer does caching for us.
	return getThumbnailURL(url, width, height, 1.0);
}
/*
	url     = URL of image (must contain a hostname)
	height  = desired height of thumbnail in pixels
	width   = desired width of thumbnail in pixels
	quality = desired quality of thumbnail (values are 0 to 2)

	If only one dimension is specified, aspect ratio will be preserved
	and the thumbnail will be a scaled version of the original.
	If both dimensions are specified, the image will be scaled and
	cropped to the desired dimensions.
*/
function getThumbnailURL (url, height, width, quality) {
	if (!height && !width) {
		throw 'height and/or width must be specified';
	}

	var BASE_URL = 'http://cards-thumbnailer.appspot.com/';
	var thumbURL = BASE_URL;

	thumbURL += encodeURIComponent(url) + '?';

	thumbURL += 'h=' + (height  || '') + '&';
	thumbURL += 'w=' + (width   || '') + '&';
	thumbURL += 'q=' + (quality || 0 );

	return thumbURL;
}
		</script>
	</body>
</html>
