<!DOCTYPE html>
<html>
	<head>
		<title>Scrollable Demo - Basic</title>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link rel="stylesheet" href="http://cdn.kik.com/app/1/default.css">
		<style>
::-webkit-scrollbar {
	height: 0 !important;
	width: 0 !important;
}
img {
	vertical-align: middle;
}
.item div {
	display: inline-block;
}
.app-list {
	-webkit-backface-visibility: hidden;
	overflow: hidden;
}
.app-list li,
.app-list li.app-button {
	height: 64px;
	padding: 4px 20px;
}
		</style>
	</head>

	<body>
		<div class="app-page" data-page="list">
			<div class="app-topbar">
				<div class="app-title">Scrollable Demo</div>
			</div>
			<div class="app-content" data-no-scroll="true">
				<ul class="app-list">
					<li class="item app-button template">
						<img src="http://placehold.it/64x64" />
						<div class="name"></div>
					</li>
				</ul>
			</div>
		</div>

		<div class="app-page" data-page="viewer">
			<div class="app-topbar">
				<div class="app-button left" data-back="true">Back</div>
				<div class="app-title"></div>
			</div>
			<div class="app-content">
				<img />
			</div>
		</div>


		<script src="http://cdn.kik.com/cards/0/cards.js"></script>
		<script src="http://cdn.kik.com/app/1/app.js"></script>

		<script src="/zerver/require.js"></script>
		<script src="../src/iscroll.js"      ></script>
		<script src="../src/scrollable.js"   ></script>
		<script src="../src/utils.js"        ></script>
		<script src="../src/scrollWatcher.js"></script>
		<script src="../src/core.js"         ></script>

		<script>
App.populator('list', function (page, data) {
	var list     = page.querySelector('.app-list');
	var content  = page.querySelector('.app-content');
	var template = list.querySelector('.template');

	template.parentNode.removeChild(template);

// 	content.style.overflow = 'scroll';
// 	content.style.webkitOverflowScrolling = 'touch';
// 	for (var i = 0; i < 500; i++) {
// 		var elm = template.cloneNode(true);
// 		generate(elm, i);
// 		list.appendChild(elm);
// 	}
	var infini = new InfiniteScroller(content, template, generate);
	if (App.platform === 'android' && App.platformVersion >= 4.0) {
		content.style.overflow = 'scroll';
		content.style.webkitOverflowScrolling = 'touch';
		content.addEventListener('scroll', function () {
			infini.setPos(content.scrollTop);
		}, false);
	} else {
		// No native scroll events :(
		// Oh well, we can emulate this.
		var iscroll = new iScroll(content, {
			onMove: function (x, y) {
				infini.setPos(-y);
			},
		});
	}

	function generate(template, i) {
		var img = template.querySelector('img');
		img.src = getImageURL(i, 64, 64);

		var text = template.querySelector('div');
		text.innerText = "Item " + i;

		template.onclick = function () {
			var w = content.offsetWidth;
			var h = content.offsetHeight;
			App.load('viewer', {
				imgsrc: getImageURL(i, w, h),
				text: "Item " + i,
			});
		};
	}
});

App.populator('viewer', function (page, data) {
	var title = page.querySelector('.app-title');
	var img = page.querySelector('img');

	title.innerText = data.text;

	var loaderImg = [
		"data:image/gif;base64,",
		"R0lGODlhEAAQAPIAAAAAAP///zw8PLy8vP///5ycnHx8fGxsbCH+GkNyZWF0ZWQgd2l0aCBhamF4",
		"bG9hZC5pbmZvACH5BAAKAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAEAAQAAADMwi63P4wyklr",
		"E2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQACgABACwAAAAA",
		"EAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUk",
		"KhIAIfkEAAoAAgAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9",
		"HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkEAAoAAwAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYum",
		"CYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkEAAoABAAsAAAAABAAEAAAAzII",
		"unInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQACgAF",
		"ACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJ",
		"ibufbSlKAAAh+QQACgAGACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFG",
		"xTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAAKAAcALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdce",
		"CAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==",
	].join('');

	var s = img.style;
	s.width = '100%';
	s.height = '100%';
	s.background = 'url(' + loaderImg + ') no-repeat center center';
	img.src = data.imgsrc;
});

var nextFrame = (function() {
	return window.requestAnimationFrame
		|| window.webkitRequestAnimationFrame
		|| window.mozRequestAnimationFrame
		|| window.oRequestAnimationFrame
		|| window.msRequestAnimationFrame
		|| function(callback) { return setTimeout(callback, 17); }
})();

try {
	App.restore();
} catch (err) {
	App.load('list');
}

function mod(a, b) {
	return ((a % b) + b) % b;
}

function InfiniteScroller(wrapper, template, filler) {
	var self = this;

	// {placeholder: <elm>, elm: <elm>, item: <number>}
	var masters = [];
	var numMasters = -1;

	var itemHeight = 72;
	var slider = wrapper.children[0];
	var curItem = 0;

	init();
	setPos(0);
	function init() {
		wrapper.style.position = 'relative';

		var s = slider.style;
		s.position = 'relative';
		s.top = '0';
		s.width = '100%';
		s.height = '100000px';

		var ts = template.style;
		ts.position = 'absolute';
		ts.width = '100%';

		numMasters = Math.ceil(window.innerHeight / itemHeight);

		for (var i = 0; i < numMasters; i++) {
			var master = initMaster(i);
			masters.push(master);
			slider.appendChild(master.placeholder);
			slider.appendChild(master.elm);
		}

		function initMaster(item) {
			var master = {
				placeholder: template.cloneNode(true),
				elm: template.cloneNode(true),
				item: item,
			};
			positionMaster(master.elm, item);
			positionMaster(master.placeholder, item);
			hideElm(master.placeholder);
			filler(master.elm, item);
			return master
		}
	}

	function hideElm(elm) {
// 		elm.style.opacity = '0';
		elm.style.visibility = 'hidden';
	}
	function showElm(elm) {
// 		elm.style.opacity = '1';
		elm.style.visibility = 'visible';
	}

	function positionMaster(elm, item) {
		showElm(elm);
		var s = elm.style;
		s.webkitTransform = 'translate3d(0px,' + item*itemHeight + 'px,0px)';
	}

	var invalidMasters = {};
	function fillAnInvalidMaster() {
		for (var invalidMaster in invalidMasters) {
			var master = masters[invalidMaster];
			filler(master.elm, master.item);
			positionMaster(master.elm, master.item);
			hideElm(master.placeholder);
			delete invalidMasters[invalidMaster];
			return;
		}
	}

	function setItem(newItem) {
		for (var i = 0; i < numMasters; i++) {
			var master = masters[i];
			invalidMasters[i] = true;

			var item = i + newItem;
			positionMaster(master.placeholder, item);
			master.item = item;
		}
		curItem = newItem;
	}

	function nextItem() {
		var movingMaster = mod(curItem, numMasters);
		var master = masters[movingMaster];
		invalidMasters[movingMaster] = true;

		var item = curItem + numMasters;
		positionMaster(master.placeholder, item);
		master.item = item;
		curItem++;
	}

	function prevItem() {
		var movingMaster = mod(curItem + numMasters - 1, numMasters);
		var master = masters[movingMaster];
		invalidMasters[movingMaster] = true;

		var item = curItem - 1;
		positionMaster(master.placeholder, item);
		master.item = item;
		curItem--;
	}

	var idleCount = 0;
	function setPos(curPos) {
		var newItem = Math.floor(curPos / itemHeight);

		if (newItem === curItem) return;

		idleCount = 0;
		if (Math.abs(newItem - curItem) >= numMasters) {
			setItem(newItem);
			return;
		}

		while (newItem > curItem) nextItem();
		while (newItem < curItem) prevItem();
	}
	self.setPos = setPos;

	function tick() {
		nextFrame(tick);
		idleCount++;
		if (idleCount > 5) {
			fillAnInvalidMaster();
			idleCount = 0;
		}
		return;
	}
	nextFrame(tick);
}

function getImageURL(num, width, height) {
	var categories = ['abstract', 'city', 'people', 'transport', 'animals', 'food', 'nature', 'business', 'nightlife', 'sports', 'cats', 'fashion', 'technics'];
	var categoryLength = 10;

	var category = categories[Math.floor(num / categoryLength) % categories.length];
	var categoryOffset = (num % categoryLength) + 1; // 1...10
	var url = 'http://lorempixel.com/' + width + '/' + height + '/' + category + '/' + categoryOffset;

	// Thumbnailer does caching for us.
	return getThumbnailURL(url, width, height, 1.0);
}
/*
	url     = URL of image (must contain a hostname)
	height  = desired height of thumbnail in pixels
	width   = desired width of thumbnail in pixels
	quality = desired quality of thumbnail (values are 0 to 2)

	If only one dimension is specified, aspect ratio will be preserved
	and the thumbnail will be a scaled version of the original.
	If both dimensions are specified, the image will be scaled and
	cropped to the desired dimensions.
*/
function getThumbnailURL (url, height, width, quality) {
	if (!height && !width) {
		throw 'height and/or width must be specified';
	}

	var BASE_URL = 'http://cards-thumbnailer.appspot.com/';
	var thumbURL = BASE_URL;

	thumbURL += encodeURIComponent(url) + '?';

	thumbURL += 'h=' + (height  || '') + '&';
	thumbURL += 'w=' + (width   || '') + '&';
	thumbURL += 'q=' + (quality || 0 );

	return thumbURL;
}
		</script>
	</body>
</html>
